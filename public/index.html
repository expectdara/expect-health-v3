<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Expect Health ‚Äî AI Pelvic Floor PT Platform v3</title>
<meta name="description" content="Utah OAIP Pilot ‚Äî AI-Augmented Pelvic Floor Physical Therapy Platform">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü©∫</text></svg>">
<style>html,body,#root{margin:0;padding:0;height:100%;width:100%}</style></head><body><div id="root"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<script type="text/babel">
const { useState, useEffect, useRef } = React;



const C={
  pink:"#FC228A",pinkL:"#FF5CA8",pinkD:"#C91A6E",
  purp:"#4C2C84",purpL:"#6B45A8",purpD:"#3A1F68",
  blue:"#008AFC",blueL:"#3AA6FF",blueD:"#0066BE",
  yel:"#D7FC51",yelD:"#A8C93E",
  white:"#FFFFFF",offW:"#F8F7FC",
  g50:"#FAFAFD",g100:"#F0EFF5",g200:"#E2E0EC",g300:"#C9C6D6",g400:"#9994AD",g500:"#6E6887",g600:"#524D66",g700:"#3A3650",g800:"#252238",g900:"#16142A",
  gn:"#22C55E",rd:"#EF4444",or:"#F59E0B",
};
const log=[];function L(t,d){log.unshift({id:`A${Date.now()}`,ts:new Date().toISOString(),type:t,...d})}

const ICIQ=[
{id:"iciq1",text:"How often do you leak urine?",opts:[["Never",0],["About once a week or less often",1],["Two or three times a week",2],["About once a day",3],["Several times a day",4],["All the time",5]]},
{id:"iciq2",text:"How much urine do you usually leak, whether you wear protection or not?",opts:[["None",0],["A small amount",2],["A moderate amount",4],["A large amount",6]]},
{id:"iciq3",text:"Overall, how much does leaking urine interfere with your everyday life? Please pick a number between 0 (not at all) and 10 (a great deal).",type:"scale",min:0,max:10,lo:"Not at all",hi:"A great deal"},
{id:"iciq4",text:"Under what circumstances does urine leak? Please select all that apply to you.",type:"multi",opts:[["Never ‚Äî urine does not leak","never"],["Leaks before you can get to the toilet","urgency"],["Leaks when you cough or sneeze","stress_cough"],["Leaks when you are physically active or exercising","stress_exercise"],["Leaks when you have finished urinating and are dressed","post_void"],["Leaks when you are asleep","nocturnal"],["Leaks for no obvious reason","unknown"],["Leaks all the time","continuous"]]},
];

// FLUTS: reordered so fl10a/10b (leak frequency) comes right after fl9a/9b (leak before toilet)
const FLUTS=[
{id:"fl2a",text:"During the night, how many times do you have to get up to urinate, on average?",opts:[["None",0],["One",1],["Two",2],["Three",3],["Four or more",4]]},
{id:"fl2b",text:"How much does getting up at night to urinate bother you? (0 = not at all, 10 = a great deal)",type:"scale",min:0,max:10,lo:"Not at all",hi:"A great deal"},
{id:"fl3a",text:"Do you have a sudden need to rush to the toilet to urinate?",opts:[["Never",0],["Occasionally",1],["Sometimes",2],["Most of the time",3],["All of the time",4]]},
{id:"fl3b",text:"How much does that sudden urgency bother you? (0 = not at all, 10 = a great deal)",type:"scale",min:0,max:10,lo:"Not at all",hi:"A great deal"},
{id:"fl4a",text:"Do you have pain in your bladder?",opts:[["Never",0],["Occasionally",1],["Sometimes",2],["Most of the time",3],["All of the time",4]]},
{id:"fl4b",text:"How much does the bladder pain bother you? (0 = not at all, 10 = a great deal)",type:"scale",min:0,max:10,lo:"Not at all",hi:"A great deal"},
{id:"fl5a",text:"How often do you pass urine during the day?",opts:[["1 to 6 times",0],["7 to 8 times",1],["9 to 10 times",2],["11 to 12 times",3],["13 or more times",4]]},
{id:"fl5b",text:"How much does your daytime urination frequency bother you? (0 = not at all, 10 = a great deal)",type:"scale",min:0,max:10,lo:"Not at all",hi:"A great deal"},
{id:"fl6a",text:"Is there a delay before you can start to urinate?",opts:[["Never",0],["Occasionally",1],["Sometimes",2],["Most of the time",3],["All of the time",4]]},
{id:"fl6b",text:"How much does that delay bother you? (0 = not at all, 10 = a great deal)",type:"scale",min:0,max:10,lo:"Not at all",hi:"A great deal"},
{id:"fl7a",text:"Do you have to strain to urinate?",opts:[["Never",0],["Occasionally",1],["Sometimes",2],["Most of the time",3],["All of the time",4]]},
{id:"fl7b",text:"How much does straining to urinate bother you? (0 = not at all, 10 = a great deal)",type:"scale",min:0,max:10,lo:"Not at all",hi:"A great deal"},
{id:"fl8a",text:"Do you stop and start more than once while you urinate?",opts:[["Never",0],["Occasionally",1],["Sometimes",2],["Most of the time",3],["All of the time",4]]},
{id:"fl8b",text:"How much does stop-and-start urination bother you? (0 = not at all, 10 = a great deal)",type:"scale",min:0,max:10,lo:"Not at all",hi:"A great deal"},
{id:"fl9a",text:"Does urine leak before you can get to the toilet?",opts:[["Never",0],["Occasionally",1],["Sometimes",2],["Most of the time",3],["All of the time",4]]},
{id:"fl9b",text:"How much does leaking before reaching the toilet bother you? (0 = not at all, 10 = a great deal)",type:"scale",min:0,max:10,lo:"Not at all",hi:"A great deal"},
{id:"fl10a",text:"How often do you leak urine?",opts:[["Never",0],["Once or less per week",1],["Two to three times per week",2],["Once per day",3],["Several times per day",4]]},
{id:"fl10b",text:"How much does leaking urine bother you? (0 = not at all, 10 = a great deal)",type:"scale",min:0,max:10,lo:"Not at all",hi:"A great deal"},
{id:"fl11a",text:"Does urine leak when you are physically active, exert yourself, cough or sneeze?",opts:[["Never",0],["Occasionally",1],["Sometimes",2],["Most of the time",3],["All of the time",4]]},
{id:"fl11b",text:"How much does leaking during physical activity bother you? (0 = not at all, 10 = a great deal)",type:"scale",min:0,max:10,lo:"Not at all",hi:"A great deal"},
{id:"fl12a",text:"Do you ever leak urine for no obvious reason and without feeling that you want to go?",opts:[["Never",0],["Occasionally",1],["Sometimes",2],["Most of the time",3],["All of the time",4]]},
{id:"fl12b",text:"How much does unexplained leaking bother you? (0 = not at all, 10 = a great deal)",type:"scale",min:0,max:10,lo:"Not at all",hi:"A great deal"},
{id:"fl13a",text:"Do you leak urine when you are asleep?",opts:[["Never",0],["Occasionally",1],["Sometimes",2],["Most of the time",3],["All of the time",4]]},
{id:"fl13b",text:"How much does leaking while asleep bother you? (0 = not at all, 10 = a great deal)",type:"scale",min:0,max:10,lo:"Not at all",hi:"A great deal"},
];

const FLUTSSEX=[
{id:"fs2a",text:"Do you have pain or discomfort because of a dry vagina?",opts:[["Not at all",0],["A little",1],["Somewhat",2],["A lot",3]]},
{id:"fs2b",text:"How much does vaginal dryness bother you? (0 = not at all, 10 = a great deal)",type:"scale",min:0,max:10,lo:"Not at all",hi:"A great deal"},
{id:"fs3a",text:"To what extent do you feel that your sex life has been affected by your urinary symptoms?",opts:[["Not at all",0],["A little",1],["Somewhat",2],["A lot",3]]},
{id:"fs3b",text:"How much does the impact on your sex life bother you? (0 = not at all, 10 = a great deal)",type:"scale",min:0,max:10,lo:"Not at all",hi:"A great deal"},
{id:"fs4a",text:"Do you have pain when you have sexual intercourse?",opts:[["Not at all",0],["A little",1],["Somewhat",2],["A lot",3],["I don't have sexual intercourse",4]]},
{id:"fs4b",text:"How much does pain during intercourse bother you? (0 = not at all, 10 = a great deal)",type:"scale",min:0,max:10,lo:"Not at all",hi:"A great deal"},
{id:"fs5a",text:"Do you leak urine when you have sexual intercourse?",opts:[["Not at all",0],["A little",1],["Somewhat",2],["A lot",3],["I don't have sexual intercourse",4]]},
{id:"fs5b",text:"How much does leaking during intercourse bother you? (0 = not at all, 10 = a great deal)",type:"scale",min:0,max:10,lo:"Not at all",hi:"A great deal"},
];

// GUPI + Pain Assessment combined into one section ("Pain & Discomfort")
const GUPI_PAIN=[
{id:"gupi1a",text:"In the last week, have you experienced any pain or discomfort at the entrance to your vagina?",type:"yn"},
{id:"gupi1b",text:"In the last week, have you experienced any pain or discomfort in your vagina?",type:"yn"},
{id:"gupi1c",text:"In the last week, have you experienced any pain or discomfort in your urethra (the small opening where urine comes out)?",type:"yn"},
{id:"gupi1d",text:"In the last week, have you experienced any pain or discomfort below your waist, in your pubic or bladder area?",type:"yn"},
{id:"gupi2a",text:"In the last week, have you experienced pain or burning during urination?",type:"yn"},
{id:"gupi2b",text:"In the last week, have you experienced pain or discomfort during or after sexual intercourse?",type:"yn"},
{id:"gupi2c",text:"In the last week, have you experienced pain or discomfort as your bladder fills?",type:"yn"},
{id:"gupi2d",text:"In the last week, have you experienced pain or discomfort that was relieved by voiding (meaning the discomfort went away or got better after you urinated)?",type:"yn"},
{id:"gupi3",text:"How often have you had pain or discomfort in any of the areas mentioned above ‚Äî including the vaginal entrance, vagina, urethra, pubic area, or bladder ‚Äî over the last week?",opts:[["Never",0],["Rarely",1],["Sometimes",2],["Often",3],["Usually",4],["Always",5]]},
{id:"gupi4",text:"Which number best describes your AVERAGE pain or discomfort on the days you had it, over the last week? (0 = no pain, 10 = pain as bad as you can imagine)",type:"scale",min:0,max:10,lo:"No pain",hi:"Pain as bad as you can imagine"},
{id:"pain1",text:"What is your current pelvic pain level right now? (0 = no pain, 10 = worst pain imaginable)",type:"scale",min:0,max:10,lo:"No pain",hi:"Worst pain imaginable"},
{id:"pain2",text:"What has your average pelvic pain been over the past week? (0 = no pain, 10 = worst pain imaginable)",type:"scale",min:0,max:10,lo:"No pain",hi:"Worst pain imaginable"},
{id:"pain3",text:"How does your pain affect your daily activities?",opts:[["No effect",0],["Mild ‚Äî I can do most activities",1],["Moderate ‚Äî I avoid some activities",2],["Severe ‚Äî I am significantly limited",3],["I cannot perform daily activities",4]]},
{id:"pain4",text:"Where do you experience pain or discomfort? Please select all that apply.",type:"multi",opts:[["None ‚Äî no pain","none"],["Lower abdomen","lower_abd"],["Perineum","perineum"],["Vaginal area","vaginal"],["Lower back","lower_back"],["Hip area","hip"],["During intercourse","dyspareunia"],["During urination","dysuria"]]},
{id:"gupi5",text:"Over the last week, how often have you had a sensation of not completely emptying your bladder after you finished urinating?",opts:[["Not at all",0],["Less than 1 time in 5",1],["Less than half the time",2],["About half the time",3],["More than half the time",4],["Almost always",5]]},
{id:"gupi6",text:"Over the last week, how often have you had to urinate again less than two hours after you finished urinating?",opts:[["Not at all",0],["Less than 1 time in 5",1],["Less than half the time",2],["About half the time",3],["More than half the time",4],["Almost always",5]]},
{id:"gupi7",text:"Over the last week, how much have your symptoms kept you from doing the kinds of things you would usually do?",opts:[["None",0],["Only a little",1],["Some",2],["A lot",3]]},
{id:"gupi8",text:"Over the last week, how much did you think about your symptoms?",opts:[["None",0],["Only a little",1],["Some",2],["A lot",3]]},
{id:"gupi9",text:"If you were to spend the rest of your life with your symptoms just the way they have been during the last week, how would you feel about that?",opts:[["Pleased",1],["Mostly satisfied",2],["Mixed ‚Äî about equally satisfied and dissatisfied",3],["Mostly dissatisfied",4],["Unhappy",5],["Terrible",6]]},
];

// Additional clinical intake
const CLINICAL_EXTRA=[
{id:"bowel_constipation",text:"Over the past month, how often have you experienced constipation or straining during bowel movements?",opts:[["Never",0],["Rarely",1],["Sometimes",2],["Often",3],["Almost always",4]]},
{id:"symptom_triggers",text:"What activities tend to trigger your symptoms? Please select all that apply.",type:"multi",opts:[["Lifting or carrying","lifting"],["Running or jumping","running"],["Coughing or sneezing","coughing"],["Laughing","laughing"],["Getting up from sitting","standing"],["Climbing stairs","stairs"],["Sexual activity","sexual"],["None in particular","none"]]},
{id:"prior_treatment",text:"Have you had any prior treatment for pelvic floor issues?",type:"multi",opts:[["None ‚Äî this is my first time","none"],["Pelvic floor PT (in-person)","prior_pt"],["Kegel exercises on my own","self_kegel"],["Pessary","pessary"],["Biofeedback device","biofeedback"],["Medication","medication"],["Surgery","surgery"]]},
{id:"medications",text:"Are you taking any medications that might affect your bladder? (e.g., diuretics, antihistamines, antidepressants)",type:"text",ph:"List medications or type 'None'"},
{id:"patient_goal",text:"In your own words, what is the main thing you'd like to be able to do more comfortably?",type:"text",ph:"e.g., 'Exercise without leaking', 'Pick up my child without pain'"},
{id:"video_breathing",text:"Optional: Would you like to upload a short video of your breathing pattern? This helps your PT assess your diaphragmatic breathing and core coordination. (15‚Äì30 seconds, front view, standing or seated.)",type:"yn"},
];

const REDFLAGS=[
{id:"rf_bleed",text:"Are you experiencing any unexplained vaginal bleeding?",type:"yn",rf:true,act:"physician",msg:"Unexplained bleeding requires physician evaluation before starting PT."},
{id:"rf_fever",text:"Do you currently have a fever ‚Äî temperature above 100.4¬∞F (38¬∞C)?",type:"yn",rf:true,act:"er",msg:"A postpartum fever may indicate infection. Please call 911 or go to the ER immediately."},
{id:"rf_chest",text:"Are you experiencing any chest pain or difficulty breathing?",type:"yn",rf:true,act:"er",msg:"This requires immediate medical attention. Please call 911."},
{id:"rf_head",text:"Do you have a severe headache along with any changes in your vision?",type:"yn",rf:true,act:"er",msg:"This could indicate a serious postpartum condition. Please call 911 immediately."},
{id:"rf_uti",text:"Are you experiencing burning during urination, blood in your urine, or frequent urination along with a fever?",type:"yn",rf:true,act:"physician",msg:"These may indicate a UTI. Please contact your physician before starting PT."},
];
// SCORING (unchanged references ‚Äî GUPI items still named gupiXX, pain items still painXX)
function sICIQ(a){const t=(a.iciq1??0)+(a.iciq2??0)+(a.iciq3??0);const sv=t===0?"None":t<=5?"Slight":t<=12?"Moderate":t<=18?"Severe":"Very Severe";const ty=a.iciq4||[];const u=ty.includes("urgency"),s=ty.includes("stress_cough")||ty.includes("stress_exercise");const sub=u&&s?"Mixed UI":u?"Urge UI":s?"Stress UI":ty.includes("continuous")?"Continuous UI":"Unclassified";return{total:t,severity:sv,subtype:sub}}
function sFLUTS(a){const F=(a.fl2a??0)+(a.fl3a??0)+(a.fl4a??0)+(a.fl5a??0);const V=(a.fl6a??0)+(a.fl7a??0)+(a.fl8a??0);const I=(a.fl9a??0)+(a.fl10a??0)+(a.fl11a??0)+(a.fl12a??0)+(a.fl13a??0);return{F,V,I,total:F+V+I}}
function sFSEX(a){return{total:(a.fs2a??0)+(a.fs3a??0)+Math.min(a.fs4a??0,3)+Math.min(a.fs5a??0,3)}}
function sGUPI(a){const p=(a.gupi1a==="yes"?1:0)+(a.gupi1b==="yes"?1:0)+(a.gupi1c==="yes"?1:0)+(a.gupi1d==="yes"?1:0)+(a.gupi2a==="yes"?1:0)+(a.gupi2b==="yes"?1:0)+(a.gupi2c==="yes"?1:0)+(a.gupi2d==="yes"?1:0)+(a.gupi3??0)+(a.gupi4??0);const u=(a.gupi5??0)+(a.gupi6??0);const q=(a.gupi7??0)+(a.gupi8??0)+(a.gupi9??0);const t=p+u+q;return{total:t,pain:p,urinary:u,qol:q,severity:t<=14?"Mild":t<=29?"Moderate":"Severe"}}
function sPain(a){const c=a.pain1??0,v=a.pain2??0,f=a.pain3??0;const cm=Math.round((c+v)/2*10)/10;return{current:c,average:v,composite:cm,functional:f,severity:cm===0?"None":cm<=3?"Mild":cm<=6?"Moderate":"Severe",locations:a.pain4||[]}}

function genPlan(iciq,pain,gupi,intake){
  const p={id:`TP-${Date.now()}`,at:new Date().toISOString(),status:"pending_review",risk:"green",dx:[],goals:[],ex:[],adjuncts:[],freq:"",dur:"",prec:[],prog:[],cpt:[]};
  if(iciq.subtype.includes("Stress"))p.dx.push({c:"N39.3",d:"Stress incontinence"});
  else if(iciq.subtype.includes("Urge"))p.dx.push({c:"N39.41",d:"Urge incontinence"});
  else if(iciq.subtype.includes("Mixed"))p.dx.push({c:"N39.46",d:"Mixed incontinence"});
  if(pain.composite>=1)p.dx.push({c:"N94.89",d:"Pelvic pain condition"});
  if(pain.locations.includes("dyspareunia"))p.dx.push({c:"N94.10",d:"Dyspareunia"});
  if(gupi?.total>=10)p.dx.push({c:"N81.9",d:"Pelvic floor dysfunction"});
  if((intake.bowel_constipation??0)>=2)p.dx.push({c:"K59.00",d:"Constipation, unspecified"});
  if(pain.current>3||iciq.severity==="Very Severe")p.risk="yellow";
  // Goals ‚Äî include patient's own goal if provided
  p.goals=[`Reduce ICIQ from ${iciq.total} by ‚â•3 pts in 8 wks`,`Improve bladder control confidence`];
  if(pain.composite>0)p.goals.push(`Reduce pain from ${pain.average}/10 to ‚â§${Math.max(0,pain.average-3)}/10`);
  if(intake.patient_goal)p.goals.push(`Patient goal: "${intake.patient_goal}"`);
  const sev=iciq.severity==="Severe"||iciq.severity==="Very Severe";
  p.ex=sev?[{n:"Supine PF Activation",s:2,r:8,h:"3-5s",f:"daily",d:"Gravity-eliminated pelvic floor awareness."},{n:"Diaphragmatic Breathing + PF",s:2,r:5,h:"full cycle",f:"2x/day",d:"Coordinated breathing for PF connection."},{n:"Gentle Bridge",s:2,r:8,h:"3s",f:"daily",d:"Supported bridge with PF engagement."},{n:"Quick-Flick Kegels",s:2,r:8,h:"1s",f:"daily",d:"Fast-twitch activation ‚Äî stop if pain >3."},{n:"Endurance Kegels",s:2,r:8,h:"5s",f:"daily",d:"Side-lying sustained hold."}]:[{n:"Quick-Flick Kegels",s:3,r:10,h:"1-2s",f:"daily",d:"Rapid PF contractions."},{n:"Endurance Kegels",s:3,r:10,h:"5-10s",f:"daily",d:"Sustained PF contractions."},{n:"Bridge + PF",s:2,r:10,h:"5s",f:"3x/wk",d:"Supine bridge with PF engagement."},{n:"Diaphragmatic Breathing",s:1,r:5,h:"full cycle",f:"daily",d:"PF relax on inhale, engage on exhale."}];
  if(pain.composite>=4)p.ex.unshift({n:"Pain De-Sensitization Breathing",s:1,r:3,h:"2 min",f:"as needed",d:"Prolonged diaphragmatic breathing for pain modulation."});
  // Adjunct recommendations based on scores and history
  if(iciq.subtype.includes("Stress")&&iciq.total>=10)p.adjuncts.push({type:"device",n:"PF Biofeedback Device",d:"Surface EMG home biofeedback (e.g., Pericoach, Elvie) for real-time PF contraction feedback.",rx:"Consider if patient does not progress with HEP alone by week 4."});
  if(iciq.subtype.includes("Stress")&&gupi?.total>=15)p.adjuncts.push({type:"device",n:"Pessary Evaluation",d:"Referral for pessary fitting (ring or Gellhorn) for mechanical support.",rx:"Refer to urogynecology if symptoms persist at week 8."});
  if(iciq.subtype.includes("Urge")||iciq.subtype.includes("Mixed"))p.adjuncts.push({type:"behavioral",n:"Bladder Training Program",d:"Timed voiding schedule with progressive interval increases. Start with current voiding interval, increase by 15 min every 1-2 weeks. Include urge suppression techniques.",rx:"Begin immediately alongside exercise program."});
  if(pain.composite>=5||pain.locations.includes("dyspareunia"))p.adjuncts.push({type:"device",n:"Vaginal Dilator Therapy",d:"Graduated silicone dilator set for desensitization and tissue mobility.",rx:"Consider if dyspareunia present. Start smallest size, progress per tolerance."});
  if((intake.bowel_constipation??0)>=2)p.adjuncts.push({type:"behavioral",n:"Bowel Management Program",d:"Toileting posture (squatty potty), fiber/fluid optimization, defecation dynamics training.",rx:"Address constipation ‚Äî straining worsens PF dysfunction."});
  p.adjuncts.push({type:"behavioral",n:"Lifestyle Modifications",d:"Caffeine reduction, fluid management (1.5-2L/day), lifting mechanics education, weight management if applicable.",rx:"Standard behavioral component of PF PT."});
  if(sev)p.adjuncts.push({type:"referral",n:"In-Person PT Evaluation",d:"If telehealth-only progress stalls, refer for in-person manual therapy assessment including internal PF exam.",rx:"Reassess at week 4. Refer if ICIQ improvement <3 pts."});
  if(pain.composite>=6)p.adjuncts.push({type:"device",n:"TENS Unit for Pain",d:"Transcutaneous electrical nerve stimulation for pelvic/perineal pain management.",rx:"Home TENS unit if pain persists above 4/10 at week 2."});
  p.freq=sev?"Daily HEP + PT review q3 days":"Daily HEP + weekly check-in";
  p.dur=sev?"12 wks (reassess wk 2,4,8)":"8 wks (reassess wk 4,8)";
  p.prec=["Stop if pain >3/10","Report bleeding/fever/UTI immediately","No lifting >15 lbs first 4 wks"];
  if(intake.pregnancy_status==="pp_early")p.prec.push("Postpartum <6wk: gentle PF only");
  p.prog=["ICIQ ‚Üì‚â•2 ‚Üí increase hold +2s","Pain ‚â§2 √ó 2wk ‚Üí add standing PF","Adherence ‚â•80% √ó 2wk ‚Üí add functional progressions"];
  p.cpt=[{c:"97161",d:"PT Eval ‚Äî Low Complexity",u:1}];
  L("plan_generated",{planId:p.id,risk:p.risk,iciq:iciq.total});return p;
}

const DPTS=[
  {id:"P001",nm:"Sarah M.",age:32,ref:"OB/GYN",iciq:[{d:"01/15",s:14},{d:"01/29",s:11},{d:"02/12",s:8}],pain:[{d:"01/15",s:5},{d:"01/29",s:3.5},{d:"02/12",s:2}],adh:87,ps:"approved",nra:"02/26",msgs:[{fr:"pt",tx:"Great progress! ICIQ dropped 3 pts.",t:"2/12 10:30am"}]},
  {id:"P002",nm:"Maria L.",age:28,ref:"Self",iciq:[{d:"01/22",s:9},{d:"02/05",s:7}],pain:[{d:"01/22",s:2},{d:"02/05",s:1}],adh:93,ps:"approved",nra:"02/19",msgs:[]},
  {id:"P003",nm:"Jennifer K.",age:35,ref:"Medicaid",iciq:[{d:"02/10",s:18}],pain:[{d:"02/10",s:6}],adh:0,ps:"pending_review",nra:"02/24",msgs:[]},
];
// STYLES
const css=`@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
*{margin:0;padding:0;box-sizing:border-box}body{background:#F8F7FC;color:#252238;font-family:'Helvetica Neue',Helvetica,'Inter',sans-serif;font-size:14px;-webkit-font-smoothing:antialiased}
.topnav{background:linear-gradient(135deg,#4C2C84 0%,#3A1F68 100%);padding:0 32px;display:flex;align-items:center;height:56px;gap:24px;position:sticky;top:0;z-index:100}
.topnav-logo{font-size:22px;font-weight:700;color:white;letter-spacing:3px}
.topnav-tabs{display:flex;gap:0;margin-left:24px}
.tt{padding:16px 20px;font-size:13px;font-weight:500;color:rgba(255,255,255,.55);cursor:pointer;border-bottom:3px solid transparent;transition:all .2s}
.tt:hover{color:rgba(255,255,255,.85)}.tt.a{color:white;border-bottom-color:#FC228A;font-weight:600}
.mn{max-width:860px;margin:0 auto;padding:28px 24px}
.mnw{max-width:1100px;margin:0 auto;padding:28px 24px}
.h1{font-size:26px;font-weight:700;color:#4C2C84;margin-bottom:4px;letter-spacing:-.3px}
.h2{font-size:18px;font-weight:600;color:#4C2C84;margin-bottom:8px}
.sub{font-size:13px;color:#6E6887;margin-bottom:20px}
.card{background:white;border:1px solid #E2E0EC;border-radius:12px;padding:20px;margin-bottom:16px;box-shadow:0 1px 3px rgba(76,44,132,.04)}
.chd{font-size:15px;font-weight:600;color:#4C2C84;margin-bottom:12px}
.btn{padding:10px 20px;border-radius:8px;border:none;font-family:inherit;font-size:13px;font-weight:600;cursor:pointer;transition:all .15s;display:inline-flex;align-items:center;gap:6px}
.bpk{background:#FC228A;color:white}.bpk:hover{background:#C91A6E}
.bpu{background:#4C2C84;color:white}.bpu:hover{background:#6B45A8}
.bbl{background:#008AFC;color:white}
.byl{background:#D7FC51;color:#3A1F68;font-weight:700}
.bo{background:white;border:1.5px solid #E2E0EC;color:#524D66}.bo:hover{border-color:#4C2C84;color:#4C2C84}
.brd{background:#EF4444;color:white}
.bsm{padding:6px 14px;font-size:12px}
.qc{background:white;border:1px solid #E2E0EC;border-radius:12px;padding:18px 22px;margin-bottom:12px}
.qt{font-size:14px;font-weight:500;color:#252238;margin-bottom:12px;line-height:1.5}
.ob{display:block;width:100%;text-align:left;padding:11px 16px;margin-bottom:5px;background:#FAFAFD;border:1.5px solid #E2E0EC;border-radius:8px;color:#3A3650;font-size:13px;cursor:pointer;transition:all .15s;font-family:inherit}
.ob:hover{border-color:#6B45A8;background:white}.ob.s{border-color:#FC228A;background:rgba(252,34,138,.05);color:#C91A6E;font-weight:600}
.mo{display:inline-flex;align-items:center;gap:6px;padding:8px 14px;margin:0 6px 6px 0;background:#FAFAFD;border:1.5px solid #E2E0EC;border-radius:24px;font-size:12px;cursor:pointer;color:#524D66;transition:all .15s}
.mo:hover{border-color:#008AFC}.mo.s{border-color:#008AFC;color:#0066BE;background:rgba(0,138,252,.05);font-weight:600}
.inp{width:100%;padding:10px 14px;background:#FAFAFD;border:1.5px solid #E2E0EC;border-radius:8px;color:#252238;font-family:inherit;font-size:13px;outline:none}
.inp:focus{border-color:#4C2C84;background:white}
.il{font-size:12px;color:#6E6887;margin-bottom:5px;font-weight:500}
textarea.inp{min-height:80px;resize:vertical}
.slr{width:100%;appearance:none;height:6px;border-radius:3px;background:#E2E0EC;outline:none;margin:8px 0}
.slr::-webkit-slider-thumb{appearance:none;width:22px;height:22px;border-radius:50%;background:#FC228A;cursor:pointer;border:3px solid white;box-shadow:0 2px 8px rgba(252,34,138,.3)}
.scv{text-align:center;font-size:36px;font-weight:700;color:#FC228A;margin:6px 0}
.scl{display:flex;justify-content:space-between;font-size:11px;color:#9994AD}
.bdg{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:600}
.ra{padding:14px 18px;border-radius:10px;border-left:4px solid;margin:12px 0;font-size:13px;line-height:1.5}
.dx{display:inline-flex;align-items:center;gap:5px;padding:5px 12px;background:rgba(0,138,252,.05);border:1.5px solid rgba(0,138,252,.2);border-radius:8px;font-size:12px;color:#0066BE;margin:0 6px 6px 0}
.exc{background:#FAFAFD;border:1px solid #E2E0EC;border-radius:10px;padding:14px 18px;margin-bottom:8px}
.exn{font-weight:600;font-size:13px;color:#4C2C84;margin-bottom:3px}
.exr{font-size:11px;color:#008AFC;font-weight:500;margin-bottom:3px}
.exd{font-size:12px;color:#6E6887}
.ck{display:flex;align-items:flex-start;gap:12px;padding:12px 0;border-bottom:1px solid #F0EFF5;cursor:pointer}.ck:last-child{border-bottom:none}
.cb{width:22px;height:22px;border-radius:6px;border:2px solid #C9C6D6;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:13px;color:white;transition:all .15s}
.cb.on{background:#008AFC;border-color:#008AFC}
.aw{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;background:rgba(252,34,138,.05);border:1.5px solid rgba(252,34,138,.2);border-radius:6px;font-size:10px;color:#FC228A;font-weight:600}
.enote{background:#FAFAFD;border:1px solid #E2E0EC;border-radius:8px;padding:18px 22px;font-size:12px;color:#524D66;white-space:pre-wrap;line-height:1.6;font-family:'Courier New',monospace}
.enl{color:#4C2C84;font-weight:700}
.tmr{font-size:28px;font-weight:700;color:#008AFC;letter-spacing:1px}
.four{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
.three{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
.two{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.sc{background:white;border:1px solid #E2E0EC;border-radius:12px;padding:16px 18px}
.scl2{font-size:11px;color:#6E6887;text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;font-weight:500}
.scv2{font-size:28px;font-weight:700;letter-spacing:-.5px}
.scs{font-size:11px;color:#9994AD;margin-top:2px}
.plr{display:grid;grid-template-columns:2fr 1fr 1fr 1fr 1fr 1fr;align-items:center;padding:12px 16px;border-bottom:1px solid #F0EFF5;font-size:12px;cursor:pointer;transition:background .1s}
.plr:hover{background:#FAFAFD}
.plh{font-size:10px;color:#9994AD;text-transform:uppercase;letter-spacing:1px;font-weight:600;cursor:default;background:#FAFAFD}
.pb{height:5px;border-radius:3px;background:#E2E0EC;overflow:hidden}.pf{height:100%;border-radius:3px}
.msg{max-width:80%;padding:10px 16px;border-radius:14px;font-size:13px;margin-bottom:8px;line-height:1.4}
.mpt{background:#4C2C84;color:white;margin-left:auto;border-bottom-right-radius:4px}
.mpa{background:#F0EFF5;color:#252238;border-bottom-left-radius:4px}
@keyframes fi{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}.fi{animation:fi .3s ease-out}
@keyframes pu{0%,100%{opacity:1}50%{opacity:.5}}.pu{animation:pu 1.5s infinite}
`;
// COMPONENTS
function Bdg({sev,sc}){const c={None:C.gn,Slight:C.gn,Mild:C.or,Moderate:C.or,Severe:C.pink,"Very Severe":C.rd}[sev]||C.g400;return<span className="bdg"style={{background:`${c}12`,color:c}}>{sc!==undefined&&<b>{sc}</b>} {sev}</span>}
function AW(){return<span className="aw">ü§ñ AI-Generated ¬∑ Requires PT Review</span>}

function Q({q,ans,set,togM,rfs,setRfs}){
  if(q.conditional&&!q.conditional(ans))return null;
  if(q.type==="date")return<div className="qc fi"><div className="qt">{q.text}</div><input className="inp"type="date"value={ans[q.id]||""}onChange={e=>set(q.id,e.target.value)}style={{width:200}}/></div>;
  if(q.type==="number")return<div className="qc fi"><div className="qt">{q.text}</div><input className="inp"type="number"min={q.min}max={q.max}value={ans[q.id]??""}onChange={e=>set(q.id,e.target.value===""?"":parseInt(e.target.value))}style={{width:120}}/></div>;
  if(q.type==="text")return<div className="qc fi"><div className="qt">{q.text}</div><input className="inp"value={ans[q.id]||""}onChange={e=>set(q.id,e.target.value)}placeholder={q.ph||""}/></div>;
  if(q.type==="twotext")return<div className="qc fi"><div className="qt">{q.text}</div><div style={{display:"flex",gap:10}}><div style={{flex:1}}><div className="il">First name</div><input className="inp"value={ans[q.id+"_first"]||""}onChange={e=>set(q.id+"_first",e.target.value)}/></div><div style={{flex:1}}><div className="il">Last name</div><input className="inp"value={ans[q.id+"_last"]||""}onChange={e=>set(q.id+"_last",e.target.value)}/></div></div></div>;
  if(q.type==="yn")return<div className="qc fi"><div className="qt">{q.text}</div><div style={{display:"flex",gap:8}}>{["No","Yes"].map(o=><button key={o}className={`ob ${ans[q.id]===o.toLowerCase()?"s":""}`}style={{flex:1,textAlign:"center"}}onClick={()=>{set(q.id,o.toLowerCase());if(q.rf&&o==="Yes")setRfs(p=>[...p.filter(f=>f.id!==q.id),{id:q.id,act:q.act,msg:q.msg}]);else if(q.rf)setRfs(p=>p.filter(f=>f.id!==q.id))}}>{o}</button>)}</div>{rfs?.find(f=>f.id===q.id)&&<div className="ra"style={{background:q.act==="er"?"#FEE2E2":"#FFF7ED",borderColor:q.act==="er"?C.rd:C.or,color:q.act==="er"?"#991B1B":"#92400E"}}>{q.act==="er"?"üö®":"‚ö†Ô∏è"} {q.msg}</div>}</div>;
  if(q.type==="scale")return<div className="qc fi"><div className="qt">{q.text}</div><div className="scv">{ans[q.id]??q.min}</div><input className="slr"type="range"min={q.min}max={q.max}value={ans[q.id]??q.min}onChange={e=>set(q.id,parseInt(e.target.value))}/><div className="scl"><span>{q.lo}</span><span>{q.hi}</span></div></div>;
  if(q.type==="multi")return<div className="qc fi"><div className="qt">{q.text}</div><div style={{display:"flex",flexWrap:"wrap"}}>{q.opts.map(([l,v])=><div key={v}className={`mo ${(ans[q.id]||[]).includes(v)?"s":""}`}onClick={()=>togM(q.id,v)}>{(ans[q.id]||[]).includes(v)?"‚úì":"‚óã"} {l}</div>)}</div></div>;
  return<div className="qc fi"><div className="qt">{q.text}</div>{q.opts.map(([l,v])=><button key={v}className={`ob ${ans[q.id]===v?"s":""}`}onClick={()=>set(q.id,v)}>{l}</button>)}</div>;
}

// Shared state for intake data flowing to PT view
let sharedIntake = null;

// CONSENT
function Consent({onDone}){
  const[ck,setCk]=useState({});
  const items=[
    {id:"ai",tx:"I understand this platform uses AI to assist in my care. A licensed Physical Therapist reviews and approves all treatment plans."},
    {id:"pt",tx:"I understand a licensed Utah PT reviews every AI recommendation. The AI supports ‚Äî but never replaces ‚Äî clinical judgment."},
    {id:"opt",tx:"I have the right to request human-only care at any time without losing access to physical therapy."},
    {id:"data",tx:"I consent to de-identified data sharing with: (1) Utah OAIP for oversight, (2) researchers under IRB protocols, (3) external auditors, (4) anonymized public dashboards."},
    {id:"pilot",tx:"I understand this is a pilot under a Regulatory Mitigation Agreement with the Utah Office of AI Policy."},
    {id:"rest",tx:"If I experience harm from an AI error, Expect Health will cover remedial in-person PT at no cost."},
    {id:"coll",tx:"Data collected includes: intake responses, scores, adherence, chat interactions, and outcomes ‚Äî all in HIPAA-compliant encrypted systems."},
    {id:"age",tx:"I confirm I am at least 18 years old and provide this consent voluntarily."},
  ];
  const ok=items.every(i=>ck[i.id]);
  return<div className="fi"><div className="h1">Informed Consent</div><div className="sub">AI-Augmented Pelvic Floor Physical Therapy ¬∑ Utah OAIP Pilot</div>
    <div className="card"style={{borderColor:C.blue}}>
      <p style={{fontSize:13,color:C.g600,marginBottom:16,lineHeight:1.7}}>Please read each statement and check the box to confirm you understand.</p>
      {items.map(i=><div key={i.id}className="ck"onClick={()=>setCk(p=>({...p,[i.id]:!p[i.id]}))}><div className={`cb ${ck[i.id]?"on":""}`}>{ck[i.id]?"‚úì":""}</div><div style={{fontSize:13,color:ck[i.id]?C.g800:C.g500,lineHeight:1.6}}>{i.tx}</div></div>)}
    </div>
    <div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}>
      <span style={{fontSize:10,color:C.g400}}>Consent v1.0 ¬∑ Feb 2026</span>
      <button className="btn bpk"disabled={!ok}onClick={()=>{L("consent_signed",{});onDone()}}style={{opacity:ok?1:.4}}>I Agree ‚Äî Continue ‚Üí</button>
    </div></div>;
}

// INTAKE
function Intake({onDone,mainRef}){
  const[step,setStep]=useState(0);const[ans,setAns]=useState({});const[rfs,setRfs]=useState([]);
  const set=(k,v)=>setAns(p=>({...p,[k]:v}));
  const togM=(k,v)=>setAns(p=>({...p,[k]:(p[k]||[]).includes(v)?(p[k]||[]).filter(x=>x!==v):[...(p[k]||[]),v]}));
  const goStep=(s)=>{setStep(s);if(mainRef?.current)mainRef.current.scrollTop=0};
  const demo=[
    {id:"name",text:"What is your name?",type:"twotext"},
    {id:"dob",text:"What is your date of birth?",type:"date"},
    {id:"pregnancy_status",text:"What is your current pregnancy status?",opts:[["Currently pregnant","pregnant"],["Postpartum (0‚Äì6 weeks)","pp_early"],["Postpartum (6 weeks ‚Äì 6 months)","pp_mid"],["Postpartum (6+ months)","pp_late"],["Not recently pregnant","not_pregnant"]]},
    {id:"delivery_type",text:"What was your most recent type of delivery?",conditional:a=>a.pregnancy_status&&!["not_pregnant","pregnant"].includes(a.pregnancy_status),opts:[["Vaginal delivery","vaginal"],["Vaginal with forceps or vacuum","assisted"],["Planned C-section","csection_planned"],["Emergency C-section","csection_emergency"]]},
    {id:"num_deliveries",text:"How many total deliveries have you had? (Enter 0 if none)",type:"number",min:0,max:20},
    {id:"referral_source",text:"How did you hear about us?",opts:[["My OB/GYN or midwife referred me","obgyn"],["I found you on my own","self"],["My Medicaid plan referred me","medicaid_mco"],["Through the Expect Fitness app","expect_app"]]},
    {id:"physician_name",text:"Who is your OB/GYN or primary physician?",type:"text",ph:"Dr. Smith"},
    {id:"physician_fax",text:"What is your physician's fax number?",type:"text",ph:"(801) 555-0100"},
    {id:"insurance_type",text:"What type of insurance do you have?",opts:[["Utah Medicaid","medicaid"],["Commercial insurance","commercial"],["Self-pay","self_pay"],["Uninsured","uninsured"]]},
    {id:"insurance_id",text:"What is your insurance member ID?",type:"text",ph:"Member ID",conditional:a=>a.insurance_type&&!["self_pay","uninsured"].includes(a.insurance_type)},
  ];
  const steps=[
    {t:"Let's Get to Know You",s:"Some basic information to get started.",qs:demo},
    {t:"Safety Check",s:"We need to make sure you're safe to proceed.",qs:REDFLAGS},
    {t:"Bladder Leakage",s:"ICIQ-UI Short Form ‚Äî thinking about the past 4 weeks.",qs:ICIQ},
    {t:"Urinary Symptoms",s:"ICIQ-FLUTS ‚Äî how you've been over the past 4 weeks. Some questions may seem similar to what you just answered ‚Äî that's normal. These are separate validated tools that measure different aspects of your symptoms.",qs:FLUTS},
    {t:"Sexual Health",s:"ICIQ-FLUTSsex ‚Äî over the past 4 weeks. All answers are confidential.",qs:FLUTSSEX},
    {t:"Pain & Discomfort",s:"All pain questions ‚Äî genitourinary pain + current pain assessment. Over the past week.",qs:GUPI_PAIN},
    {t:"Your History & Goals",s:"A few more questions to help your PT create the best plan for you.",qs:CLINICAL_EXTRA},
  ];
  const hasER=rfs.some(f=>f.act==="er");
  if(step===steps.length){
    const iciq=sICIQ(ans),pain=sPain(ans),gupi=sGUPI(ans),fluts=sFLUTS(ans),fsex=sFSEX(ans),plan=genPlan(iciq,pain,gupi,ans);
    L("intake_done",{iciq:iciq.total,pain:pain.composite,gupi:gupi.total});
    // Store for PT view
    sharedIntake={ans,iciq,pain,gupi,fluts,fsex,plan,name:(ans.name_first||"")+" "+(ans.name_last||""),physicianName:ans.physician_name,physicianFax:ans.physician_fax};
    return<PatientDone name={ans.name_first}/>;
  }
  return<div className="fi">
    <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:16}}>
      <div><div className="h1">{steps[step].t}</div><div className="sub"style={{maxWidth:600}}>{steps[step].s}</div></div>
      <div style={{background:C.purp,color:C.white,padding:"6px 14px",borderRadius:20,fontSize:12,fontWeight:600,flexShrink:0}}>{step+1} / {steps.length}</div>
    </div>
    <div style={{display:"flex",gap:3,marginBottom:20}}>{steps.map((_,i)=><div key={i}style={{flex:1,height:4,borderRadius:2,background:i<=step?`linear-gradient(90deg,${C.pink},${C.purp})`:C.g200,transition:"all .3s"}}/>)}</div>
    {hasER&&step===1&&<div className="ra"style={{background:"#FEE2E2",borderColor:C.rd,color:"#991B1B",fontSize:15,fontWeight:600,marginBottom:14}}>üö® STOP ‚Äî Please call 911 or go to the nearest emergency room.</div>}
    {steps[step].qs.map(q=><Q key={q.id}q={q}ans={ans}set={set}togM={togM}rfs={rfs}setRfs={setRfs}/>)}
    <div style={{display:"flex",justifyContent:"space-between",marginTop:20}}>
      <button className="btn bo"onClick={()=>step>0&&goStep(step-1)}disabled={step===0}>‚Üê Back</button>
      <button className="btn bpk"onClick={()=>{if(!(hasER&&step===1))goStep(step+1)}}disabled={hasER&&step===1}>{step===steps.length-1?"Submit Assessment ‚Üí":"Continue ‚Üí"}</button>
    </div></div>;
}

function PatientDone({name}){
  return<div className="fi"style={{textAlign:"center",padding:"60px 20px"}}>
    <div style={{fontSize:48,marginBottom:16}}>‚ú®</div>
    <div className="h1"style={{fontSize:28}}>Thank you{name?`, ${name}`:""}</div>
    <p style={{fontSize:15,color:C.g500,maxWidth:480,margin:"12px auto 0",lineHeight:1.7}}>Your assessment is complete. A licensed Physical Therapist will review your responses and create a personalized treatment plan. You'll receive a notification when your plan is ready.</p>
    <div style={{marginTop:24,padding:16,background:C.g50,borderRadius:12,display:"inline-block"}}>
      <div style={{fontSize:12,color:C.g400,marginBottom:4}}>What happens next</div>
      <div style={{fontSize:13,color:C.g700}}>PT review within 24 hours ‚Üí Plan sent to you + your physician</div>
    </div>
  </div>;
}
// PT VIEW

// Helper: render a patient's answer for PT review
function AnsRow({label,value,score,flag}){
  if(value===undefined||value===null||value==="")return null;
  const display=typeof value==="object"?value.join(", "):String(value);
  return<div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",padding:"6px 0",borderBottom:`1px solid ${C.g100}`,fontSize:12}}>
    <div style={{color:C.g600,flex:3,lineHeight:1.4}}>{label}</div>
    <div style={{flex:2,fontWeight:600,color:flag?C.rd:C.g800,textAlign:"right"}}>{display}{flag&&" ‚ö†Ô∏è"}</div>
    {score!==undefined&&<div style={{width:50,textAlign:"right",color:C.blue,fontWeight:600,fontSize:11}}>+{score}</div>}
  </div>;
}

// Collapsible section
function Section({title,tag,defaultOpen,children}){
  const[open,setOpen]=useState(defaultOpen||false);
  return<div className="card"style={{padding:0,overflow:"hidden",marginBottom:10}}>
    <div onClick={()=>setOpen(!open)}style={{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"12px 18px",cursor:"pointer",background:open?C.g50:"white"}}>
      <div style={{display:"flex",alignItems:"center",gap:8}}><span style={{fontSize:13,fontWeight:600,color:C.purp}}>{title}</span>{tag&&<span className="bdg"style={{background:`${C.blue}12`,color:C.blue}}>{tag}</span>}</div>
      <span style={{color:C.g400,fontSize:18,transition:"transform .2s",transform:open?"rotate(180deg)":"rotate(0)"}}>{open?"‚ñæ":"‚ñ∏"}</span>
    </div>
    {open&&<div style={{padding:"8px 18px 14px",borderTop:`1px solid ${C.g100}`}}>{children}</div>}
  </div>;
}

// Build answer lookup helpers
function getOptLabel(qs,id,val){const q=qs.find(q=>q.id===id);if(!q)return val;if(q.type==="yn")return val==="yes"?"Yes":"No";if(q.type==="scale")return val+"/"+q.max;if(q.type==="multi"&&Array.isArray(val)){return val.map(v=>{const o=q.opts?.find(([l,ov])=>ov===v);return o?o[0]:v}).join(", ")}if(q.opts){const o=q.opts.find(([l,ov])=>ov===val);return o?o[0]:val}return val}
function getOptScore(qs,id,val){const q=qs.find(q=>q.id===id);if(!q)return undefined;if(q.type==="yn")return val==="yes"?1:0;if(q.type==="scale")return val;if(q.type==="multi"&&Array.isArray(val))return val.length;if(q.opts){const o=q.opts.find(([l,ov])=>ov===val);return typeof o?.[1]==="number"?o[1]:undefined}return undefined}

function PTReview(){
  const[sel,setSel]=useState(null);const[viewNew,setViewNew]=useState(false);
  if(viewNew&&sharedIntake)return<PTNewIntakeReview data={sharedIntake}onBack={()=>setViewNew(false)}/>;
  if(sel)return<PTPatientDetail pt={sel}onBack={()=>setSel(null)}/>;
  const pend=DPTS.filter(p=>p.ps==="pending_review").length+(sharedIntake?1:0);
  return<div className="fi"><div className="h1">Patient Caseload</div><div className="sub">{pend} pending review ¬∑ {DPTS.length+(sharedIntake?1:0)} total</div>
    {sharedIntake&&<div className="card fi"style={{borderColor:C.pink,cursor:"pointer"}}onClick={()=>setViewNew(true)}>
      <div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}>
        <div><div style={{fontWeight:700,fontSize:15,color:C.pink}}>üÜï New Intake ‚Äî {sharedIntake.name}</div>
        <div style={{fontSize:12,color:C.g500,marginTop:2}}>Completed just now ¬∑ AI plan generated ¬∑ Awaiting your review</div></div>
        <span className="bdg pu"style={{background:`${C.or}15`,color:C.or}}>‚è≥ Review Now</span>
      </div></div>}
    <div className="card"style={{padding:0,overflow:"hidden"}}>
      <div className="plr plh"><span>Patient</span><span>ICIQ</span><span>Pain</span><span>Adherence</span><span>Status</span><span>Next RA</span></div>
      {DPTS.map(p=>{const li=p.iciq[p.iciq.length-1].s,lp=p.pain[p.pain.length-1].s;return<div className="plr"key={p.id}onClick={()=>setSel(p)}>
        <div><div style={{fontWeight:600}}>{p.nm}</div><div style={{fontSize:10,color:C.g400}}>Age {p.age} ¬∑ {p.ref}</div></div>
        <Bdg sev={li<=5?"Slight":li<=12?"Moderate":li<=18?"Severe":"Very Severe"}sc={li}/>
        <Bdg sev={lp<=3?"Mild":lp<=6?"Moderate":"Severe"}sc={lp}/>
        <div><div className="pb"style={{width:60}}><div className="pf"style={{width:`${p.adh}%`,background:p.adh>=80?C.gn:C.or}}/></div><div style={{fontSize:10,color:C.g400,marginTop:2}}>{p.adh}%</div></div>
        <div><span style={{width:7,height:7,borderRadius:"50%",display:"inline-block",marginRight:5,background:p.ps==="approved"?C.gn:C.or}}/>{p.ps==="pending_review"?"Review":"Active"}</div>
        <div style={{fontSize:11,color:C.g400}}>{p.nra}</div>
      </div>})}
    </div></div>;
}

function PTNewIntakeReview({data,onBack}){
  const{ans,iciq,pain,gupi,fluts,fsex,plan:initPlan}=data;
  // Editable state for iterative review
  const[plan,setPlan]=useState(JSON.parse(JSON.stringify(initPlan)));
  const[editGoals,setEditGoals]=useState(initPlan.goals.join("\n"));
  const[editPrec,setEditPrec]=useState(initPlan.prec.join("\n"));
  const[editProg,setEditProg]=useState(initPlan.prog.join("\n"));
  const[editAdj,setEditAdj]=useState(initPlan.adjuncts||[]);
  const[newAdj,setNewAdj]=useState({type:"device",n:"",d:"",rx:""});
  const[editExs,setEditExs]=useState(initPlan.ex.map(e=>({...e})));
  const[editNote,setEditNote]=useState("");
  const[noteGenerated,setNoteGenerated]=useState(false);
  const[tRun,setTRun]=useState(false);const[tSec,setTSec]=useState(0);const[notes,setNotes]=useState("");
  const[faxSt,setFaxSt]=useState(null);const[patSent,setPatSent]=useState(false);
  const[approved,setApproved]=useState(false);const[showGuardrails,setShowGuardrails]=useState(false);
  const tmRef=useRef();
  useEffect(()=>{if(tRun)tmRef.current=setInterval(()=>setTSec(s=>s+1),1000);else clearInterval(tmRef.current);return()=>clearInterval(tmRef.current)},[tRun]);
  const rc={green:C.gn,yellow:C.or,red:C.rd}[plan.risk];
  const nm=(ans.name_first||"")+" "+(ans.name_last||"");

  // Build encounter note text
  const buildNote=()=>{
    const dx=plan.dx.map(d=>`${d.c} ‚Äî ${d.d}`).join("; ");
    const exList=editExs.map(e=>`${e.n}: ${e.s}x${e.r}, hold ${e.h}, ${e.f}`).join("\n");
    const adjList=(editAdj||[]).map(a=>`[${a.type.toUpperCase()}] ${a.n}: ${a.rx}`).join("\n");
    return `PHYSICAL THERAPY ENCOUNTER NOTE\nPatient: ${nm} | DOB: ${ans.dob||"‚Äî"}\nDOS: ${new Date().toISOString().split("T")[0]} | POS: 10 (Telehealth) | Mod: GQ\n\nSUBJECTIVE:\nInitial evaluation. ICIQ-UI SF: ${iciq.total} (${iciq.severity}, ${iciq.subtype}). FLUTS: F${fluts.F}/V${fluts.V}/I${fluts.I}. GUPI: ${gupi.total} (${gupi.severity}). Pain: ${pain.composite}/10 (${pain.severity}). FLUTSsex: ${fsex.total}.\n${ans.patient_goal?`Patient goal: "${ans.patient_goal}"\n`:""}${ans.prior_treatment?`Prior treatment: ${Array.isArray(ans.prior_treatment)?ans.prior_treatment.join(", "):ans.prior_treatment}\n`:""}${ans.medications?`Medications: ${ans.medications}\n`:""}\nOBJECTIVE:\nValidated instruments administered via AI-augmented telehealth. Red flags: all negative.\nStatus: ${ans.pregnancy_status?.replace(/_/g," ")||"N/A"}. Constipation: ${ans.bowel_constipation>=2?"Yes":"No"}.\n\nASSESSMENT:\n${dx}\n\nPLAN:\nExercises:\n${exList}\n\nAdjuncts/Devices:\n${adjList||"None"}\n\nGoals:\n${editGoals}\n\nPrecautions:\n${editPrec}\n\nProgression:\n${editProg}\n\nFrequency: ${plan.freq}. Duration: ${plan.dur}.\n\nCPT: ${plan.cpt.map(c=>`${c.c} ‚Äî ${c.d} (${c.u}u)`).join(", ")}\nReview time: ${Math.floor(tSec/60)}m ${tSec%60}s${notes?`\n\nPT CLINICAL NOTES:\n${notes}`:""}\n\nATTESTATION:\nI have reviewed the AI-generated assessment, the patient's individual responses, and the treatment plan. ${notes?"Modifications noted. ":""}This reflects my independent clinical judgment.\n\nSigned: [PT Name, DPT] ‚Äî ${new Date().toISOString()}`;
  };
  const genNote=()=>{setEditNote(buildNote());setNoteGenerated(true)};

  // Guardrail checks
  const guardrails=[];
  if(tSec<120)guardrails.push({lvl:"warn",msg:`Review time is ${tSec}s ‚Äî CMS may question reviews under 2 minutes. Continue reviewing before approving.`});
  if(REDFLAGS.some(r=>ans[r.id]==="yes"))guardrails.push({lvl:"alert",msg:"‚ö†Ô∏è Patient had positive red flag(s) in safety screening. Verify these were addressed."});
  if(iciq.severity==="Very Severe"&&editExs.length<4)guardrails.push({lvl:"warn",msg:"Very Severe ICIQ score but fewer than 4 exercises ‚Äî consider whether prescription is sufficient."});
  if(notes.trim().length===0&&editExs.some((e,i)=>JSON.stringify(e)!==JSON.stringify(initPlan.ex[i])))guardrails.push({lvl:"warn",msg:"You modified exercises but haven't added clinical rationale in the notes. CMS and OAIP require documented reasoning."});
  if(!noteGenerated)guardrails.push({lvl:"info",msg:"Generate and review the encounter note before approving."});

  const tryApprove=()=>{if(guardrails.some(g=>g.lvl==="alert"||g.lvl==="warn"))setShowGuardrails(true);else doFinalApprove()};
  const doFinalApprove=()=>{setTRun(false);setApproved(true);setShowGuardrails(false);
    setPlan(p=>({...p,status:"approved",goals:editGoals.split("\n").filter(Boolean),prec:editPrec.split("\n").filter(Boolean),prog:editProg.split("\n").filter(Boolean),ex:editExs,adjuncts:editAdj}));
    L("plan_reviewed",{patient:nm,action:"approved",time:tSec});L("encounter_note",{patient:nm,cpt:plan.cpt.map(c=>c.c),time:tSec})};

  const removeEx=(i)=>setEditExs(e=>e.filter((_,j)=>j!==i));
  const updateEx=(i,field,val)=>setEditExs(e=>e.map((ex,j)=>j===i?{...ex,[field]:val}:ex));
  const addEx=()=>setEditExs(e=>[...e,{n:"New Exercise",s:2,r:8,h:"5s",f:"daily",d:"Description"}]);
  const removeAdj=(i)=>setEditAdj(a=>a.filter((_,j)=>j!==i));
  const addAdj=()=>{if(newAdj.n.trim()){setEditAdj(a=>[...a,{...newAdj}]);setNewAdj({type:"device",n:"",d:"",rx:""})}};

  return<div className="fi">
    <button className="btn bo bsm"onClick={onBack}style={{marginBottom:16}}>‚Üê Back to Patients</button>
    <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start"}}>
      <div><div className="h1">Intake Review ‚Äî {nm}</div><div className="sub">DOB: {ans.dob||"‚Äî"} ¬∑ {ans.pregnancy_status?.replace(/_/g," ")||"‚Äî"} ¬∑ Ref: {ans.referral_source||"‚Äî"} ¬∑ Insurance: {ans.insurance_type||"‚Äî"}{ans.patient_goal?` ¬∑ Goal: "${ans.patient_goal}"`:""}</div></div>
      <AW/>
    </div>

    {/* SCORE SUMMARY */}
    <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr 1fr 1fr",gap:10,marginBottom:14}}>
      <div className="sc"><div className="scl2">ICIQ-UI SF</div><div className="scv2"style={{color:C.pink}}>{iciq.total}</div><Bdg sev={iciq.severity}/><div className="scs">{iciq.subtype} ¬∑ 0‚Äì21</div></div>
      <div className="sc"><div className="scl2">FLUTS</div><div className="scv2"style={{color:C.purp}}>{fluts.total}</div><div className="scs">F:{fluts.F}/16 V:{fluts.V}/12 I:{fluts.I}/20</div></div>
      <div className="sc"><div className="scl2">FLUTSsex</div><div className="scv2"style={{color:C.purpL}}>{fsex.total}</div><div className="scs">Sexual symptom score</div></div>
      <div className="sc"><div className="scl2">GUPI-F</div><div className="scv2"style={{color:C.blue}}>{gupi.total}</div><Bdg sev={gupi.severity}/><div className="scs">P:{gupi.pain}/23 U:{gupi.urinary}/10 Q:{gupi.qol}/12</div></div>
      <div className="sc"><div className="scl2">Pain</div><div className="scv2"style={{color:C.or}}>{pain.composite}</div><Bdg sev={pain.severity}/><div className="scs">Fn: {["None","Mild","Mod","Sev","Cannot"][pain.functional]}</div></div>
    </div>

    {/* PATIENT RESPONSES ‚Äî collapsible */}
    <div style={{marginBottom:14}}>
      <div style={{fontSize:14,fontWeight:600,color:C.purp,marginBottom:8}}>üìã Patient Responses <span style={{fontWeight:400,fontSize:12,color:C.g400}}>‚Äî expand to verify AI scoring</span></div>
      <Section title="Demographics & History" tag={ans.pregnancy_status?.replace(/_/g," ")||""}>
        <AnsRow label="Name" value={nm}/>
        <AnsRow label="Date of birth" value={ans.dob}/>
        <AnsRow label="Pregnancy status" value={ans.pregnancy_status?.replace(/_/g," ")}/>
        <AnsRow label="Delivery type" value={ans.delivery_type?.replace(/_/g," ")}/>
        <AnsRow label="Total deliveries" value={ans.num_deliveries}/>
        <AnsRow label="Prior treatments" value={Array.isArray(ans.prior_treatment)?ans.prior_treatment.join(", "):ans.prior_treatment}/>
        <AnsRow label="Medications" value={ans.medications}/>
        <AnsRow label="Patient goal" value={ans.patient_goal}/>
        <AnsRow label="Constipation" value={getOptLabel([{id:"x",opts:[["Never",0],["Rarely",1],["Sometimes",2],["Often",3],["Almost always",4]]}],"x",ans.bowel_constipation)}/>
        <AnsRow label="Symptom triggers" value={Array.isArray(ans.symptom_triggers)?ans.symptom_triggers.join(", "):ans.symptom_triggers}/>
        <AnsRow label="Video upload interest" value={ans.video_breathing==="yes"?"Yes ‚Äî patient wants to submit":"No"}/>
      </Section>
      <Section title="Safety Screening" tag={REDFLAGS.some(r=>ans[r.id]==="yes")?"‚ö†Ô∏è FLAGS":"‚úì Clear"} defaultOpen={REDFLAGS.some(r=>ans[r.id]==="yes")}>
        {REDFLAGS.map(r=><AnsRow key={r.id} label={r.text} value={ans[r.id]==="yes"?"YES":"No"} flag={ans[r.id]==="yes"}/>)}
      </Section>
      <Section title="ICIQ-UI Short Form" tag={`${iciq.total}/21 ¬∑ ${iciq.severity}`}>
        {ICIQ.map(q=><AnsRow key={q.id} label={q.text.slice(0,80)+(q.text.length>80?"...":"")} value={getOptLabel(ICIQ,q.id,ans[q.id])} score={q.type!=="multi"?getOptScore(ICIQ,q.id,ans[q.id]):undefined}/>)}
        <div style={{marginTop:6,fontSize:11,color:C.blue,fontWeight:600}}>‚Üí {iciq.subtype}</div>
      </Section>
      <Section title="ICIQ-FLUTS ‚Äî Filling" tag={`F: ${fluts.F}/16`}>
        {FLUTS.filter(q=>["fl2a","fl2b","fl3a","fl3b","fl4a","fl4b","fl5a","fl5b"].includes(q.id)).map(q=><AnsRow key={q.id} label={q.text.slice(0,80)+"..."} value={getOptLabel(FLUTS,q.id,ans[q.id])} score={q.id.endsWith("a")?getOptScore(FLUTS,q.id,ans[q.id]):undefined}/>)}
      </Section>
      <Section title="ICIQ-FLUTS ‚Äî Voiding" tag={`V: ${fluts.V}/12`}>
        {FLUTS.filter(q=>["fl6a","fl6b","fl7a","fl7b","fl8a","fl8b"].includes(q.id)).map(q=><AnsRow key={q.id} label={q.text.slice(0,80)+"..."} value={getOptLabel(FLUTS,q.id,ans[q.id])} score={q.id.endsWith("a")?getOptScore(FLUTS,q.id,ans[q.id]):undefined}/>)}
      </Section>
      <Section title="ICIQ-FLUTS ‚Äî Incontinence" tag={`I: ${fluts.I}/20`}>
        {FLUTS.filter(q=>q.id>="fl9a").map(q=><AnsRow key={q.id} label={q.text.slice(0,80)+"..."} value={getOptLabel(FLUTS,q.id,ans[q.id])} score={q.id.endsWith("a")?getOptScore(FLUTS,q.id,ans[q.id]):undefined}/>)}
      </Section>
      <Section title="FLUTSsex" tag={`Score: ${fsex.total}`}>
        {FLUTSSEX.map(q=><AnsRow key={q.id} label={q.text.slice(0,80)+"..."} value={getOptLabel(FLUTSSEX,q.id,ans[q.id])} score={q.id.endsWith("a")?getOptScore(FLUTSSEX,q.id,ans[q.id]):undefined}/>)}
      </Section>
      <Section title="GUPI + Pain" tag={`GUPI: ${gupi.total}/45 ¬∑ Pain: ${pain.composite}/10`}>
        {GUPI_PAIN.map(q=><AnsRow key={q.id} label={q.text.slice(0,90)+(q.text.length>90?"...":"")} value={getOptLabel(GUPI_PAIN,q.id,ans[q.id])} score={q.type!=="multi"?getOptScore(GUPI_PAIN,q.id,ans[q.id]):undefined}/>)}
      </Section>
    </div>

    {/* DIAGNOSES */}
    <div className="card">
      <div className="chd">ICD-10 Diagnoses (AI-Generated)</div>
      <div style={{display:"flex",flexWrap:"wrap"}}>{plan.dx.map(d=><div className="dx"key={d.c}><b>{d.c}</b> {d.d}</div>)}</div>
      <div style={{marginTop:10}}><span className="bdg"style={{background:`${rc}15`,color:rc}}>‚óè Risk: {plan.risk==="green"?"Green":"Yellow ‚Äî Elevated"}</span></div>
    </div>

    {/* EDITABLE TREATMENT PLAN */}
    <div className="card"style={{borderColor:approved?C.gn:C.pink}}>
      <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:14}}>
        <div className="chd"style={{marginBottom:0}}>{approved?"Approved ":""}Treatment Plan {!approved&&"(Editable)"}</div>
        {approved?<span className="bdg"style={{background:`${C.gn}15`,color:C.gn}}>‚úì Approved</span>:<span className="bdg pu"style={{background:`${C.or}15`,color:C.or}}>‚è≥ Review</span>}
      </div>

      {/* Editable Goals */}
      <div style={{marginBottom:12}}><div className="il">Goals (edit below)</div>
        {approved?<div style={{fontSize:13,whiteSpace:"pre-wrap"}}>{editGoals}</div>:<textarea className="inp"value={editGoals}onChange={e=>setEditGoals(e.target.value)}rows={3}/>}
      </div>

      {/* Editable Exercises */}
      <div style={{marginBottom:12}}><div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}><div className="il">Exercise Prescription ¬∑ {plan.freq} ¬∑ {plan.dur}</div>{!approved&&<button className="btn bo bsm"onClick={addEx}>+ Add Exercise</button>}</div>
        {editExs.map((e,i)=><div className="exc"key={i}style={{position:"relative"}}>
          {!approved&&<button style={{position:"absolute",top:8,right:8,background:"none",border:"none",color:C.rd,cursor:"pointer",fontSize:14}}onClick={()=>removeEx(i)}>‚úï</button>}
          {approved?<><div className="exn">{e.n}</div><div className="exr">{e.s}√ó{e.r} ¬∑ Hold: {e.h} ¬∑ {e.f}</div><div className="exd">{e.d}</div></>:
          <div style={{display:"grid",gridTemplateColumns:"2fr 1fr 1fr 1fr 1fr",gap:6}}>
            <div><div className="il">Name</div><input className="inp"value={e.n}onChange={v=>updateEx(i,"n",v.target.value)}/></div>
            <div><div className="il">Sets</div><input className="inp"type="number"value={e.s}onChange={v=>updateEx(i,"s",+v.target.value)}/></div>
            <div><div className="il">Reps</div><input className="inp"type="number"value={e.r}onChange={v=>updateEx(i,"r",+v.target.value)}/></div>
            <div><div className="il">Hold</div><input className="inp"value={e.h}onChange={v=>updateEx(i,"h",v.target.value)}/></div>
            <div><div className="il">Freq</div><input className="inp"value={e.f}onChange={v=>updateEx(i,"f",v.target.value)}/></div>
          </div>}
        </div>)}
      </div>

      {/* Editable Adjuncts/Devices */}
      <div style={{marginBottom:12}}><div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}><div className="il">Recommended Adjuncts & Devices</div></div>
        {editAdj.map((a,i)=><div className="exc"key={i}style={{borderLeft:`3px solid ${a.type==="device"?C.blue:a.type==="referral"?C.pink:C.or}`}}>
          <div style={{display:"flex",justifyContent:"space-between"}}>
            <div><span className="bdg"style={{background:`${a.type==="device"?C.blue:a.type==="referral"?C.pink:C.or}12`,color:a.type==="device"?C.blue:a.type==="referral"?C.pink:C.or,marginRight:6}}>{a.type}</span><b style={{fontSize:13}}>{a.n}</b></div>
            {!approved&&<button style={{background:"none",border:"none",color:C.rd,cursor:"pointer"}}onClick={()=>removeAdj(i)}>‚úï</button>}
          </div>
          <div style={{fontSize:12,color:C.g500,marginTop:3}}>{a.d}</div>
          <div style={{fontSize:11,color:C.blue,marginTop:2}}>Rx: {a.rx}</div>
        </div>)}
        {!approved&&<div style={{display:"grid",gridTemplateColumns:"auto 2fr 2fr 2fr auto",gap:6,marginTop:8,alignItems:"end"}}>
          <div><div className="il">Type</div><select className="inp"value={newAdj.type}onChange={e=>setNewAdj(p=>({...p,type:e.target.value}))}><option value="device">Device</option><option value="behavioral">Behavioral</option><option value="referral">Referral</option></select></div>
          <div><div className="il">Name</div><input className="inp"value={newAdj.n}onChange={e=>setNewAdj(p=>({...p,n:e.target.value}))}/></div>
          <div><div className="il">Description</div><input className="inp"value={newAdj.d}onChange={e=>setNewAdj(p=>({...p,d:e.target.value}))}/></div>
          <div><div className="il">Recommendation</div><input className="inp"value={newAdj.rx}onChange={e=>setNewAdj(p=>({...p,rx:e.target.value}))}/></div>
          <button className="btn bbl bsm"onClick={addAdj}>+ Add</button>
        </div>}
      </div>

      {/* Editable Precautions + Progression */}
      <div className="two"style={{marginBottom:12}}>
        <div><div className="il">Precautions</div>{approved?<div style={{fontSize:12,whiteSpace:"pre-wrap"}}>{editPrec}</div>:<textarea className="inp"value={editPrec}onChange={e=>setEditPrec(e.target.value)}rows={3}/>}</div>
        <div><div className="il">Progression Criteria</div>{approved?<div style={{fontSize:12,whiteSpace:"pre-wrap"}}>{editProg}</div>:<textarea className="inp"value={editProg}onChange={e=>setEditProg(e.target.value)}rows={3}/>}</div>
      </div>
      <div><div className="il">CPT Codes</div>{plan.cpt.map(c=><div className="dx"key={c.c}><b>{c.c}</b> {c.d} ¬∑ {c.u}u</div>)}</div>
    </div>

    {/* REVIEW CONTROLS ‚Äî timer, notes, generate note, approve */}
    {!approved&&<div className="card"style={{borderColor:C.purp}}>
      <div className="chd"style={{color:C.purp}}>PT Review</div>
      <div style={{display:"flex",alignItems:"center",gap:10,marginBottom:12}}>
        <span className="tmr">{String(Math.floor(tSec/60)).padStart(2,"0")}:{String(tSec%60).padStart(2,"0")}</span>
        <button className={`btn ${tRun?"brd":"bbl"} bsm`}onClick={()=>setTRun(!tRun)}>{tRun?"‚è∏ Pause":"‚ñ∂ Start Timer"}</button>
        <span style={{fontSize:10,color:C.g400}}>CMS time documentation</span>
      </div>
      <div className="il">Clinical Notes / Modifications / Rationale:</div>
      <textarea className="inp"placeholder="Document your clinical reasoning, any modifications, and rationale..."value={notes}onChange={e=>setNotes(e.target.value)}style={{marginBottom:12}}/>

      <button className="btn bpu"onClick={genNote}style={{marginBottom:12}}>{noteGenerated?"‚Üª Regenerate Encounter Note":"üìù Generate Encounter Note"}</button>

      {noteGenerated&&<div style={{marginBottom:12}}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:6}}><div className="il">Encounter Note (editable ‚Äî review before approving)</div><button className="btn bo bsm"onClick={()=>navigator.clipboard?.writeText(editNote)}>üìã Copy</button></div>
        <textarea className="inp"value={editNote}onChange={e=>setEditNote(e.target.value)}style={{fontFamily:"'Courier New',monospace",fontSize:11,minHeight:200,lineHeight:1.5}}/>
      </div>}

      {/* GUARDRAIL MODAL */}
      {showGuardrails&&<div style={{background:`${C.or}08`,border:`2px solid ${C.or}`,borderRadius:12,padding:18,marginBottom:12}}>
        <div style={{fontWeight:700,color:C.or,marginBottom:8}}>‚ö†Ô∏è Pre-Approval Checks</div>
        {guardrails.map((g,i)=><div key={i}style={{fontSize:12,marginBottom:6,padding:"6px 10px",borderRadius:6,background:g.lvl==="alert"?`${C.rd}10`:g.lvl==="warn"?`${C.or}10`:`${C.blue}08`,color:g.lvl==="alert"?C.rd:g.lvl==="warn"?C.or:C.blue}}>{g.msg}</div>)}
        <div style={{display:"flex",gap:6,marginTop:10}}>
          <button className="btn bo bsm"onClick={()=>setShowGuardrails(false)}>‚Üê Go Back & Fix</button>
          <button className="btn brd bsm"onClick={doFinalApprove}>I've reviewed ‚Äî Approve Anyway</button>
        </div>
      </div>}

      {!showGuardrails&&<div style={{display:"flex",gap:6}}>
        <button className="btn bbl"onClick={tryApprove}>‚úì Approve Plan</button>
        <button className="btn brd"onClick={()=>{L("plan_rejected",{patient:nm});setPlan(p=>({...p,status:"rejected"}))}}>‚úï Reject</button>
      </div>}
    </div>}

    {/* POST-APPROVAL: Fax + Notify */}
    {approved&&<div className="two">
      <div className="card fi">
        <div className="chd">üì† Fax to Physician</div>
        <div style={{fontSize:13,color:C.g600,marginBottom:8}}>Send encounter note + care plan to <b>{ans.physician_name||"Physician"}</b></div>
        <div style={{display:"flex",gap:6,alignItems:"center",marginBottom:10}}>
          <input className="inp"value={ans.physician_fax||""}readOnly style={{width:180}}/>
          <button className="btn bpu bsm"disabled={faxSt==="sending"}onClick={()=>{setFaxSt("sending");L("fax_init",{to:ans.physician_name});setTimeout(()=>{setFaxSt("sent");L("fax_confirmed",{conf:`FAX-${Date.now().toString(36).toUpperCase()}`})},2000)}}>{faxSt==="sending"?"Sending...":"Send HIPAA Fax"}</button>
        </div>
        {faxSt==="sent"&&<div style={{padding:"8px 14px",borderRadius:8,background:`${C.gn}10`,color:C.gn,fontSize:12,fontWeight:600}}>‚úì Fax sent ¬∑ Logged</div>}
      </div>
      <div className="card fi">
        <div className="chd">üì± Send to Patient</div>
        <div style={{fontSize:13,color:C.g600,marginBottom:8}}>Notify <b>{nm}</b> their plan is ready</div>
        <div style={{fontSize:12,color:C.g500,marginBottom:10}}>Patient receives: exercises, adjuncts, goals, precautions. Scores and diagnoses are not shared.</div>
        <button className="btn bpk bsm"disabled={patSent}onClick={()=>{setPatSent(true);L("plan_sent_patient",{patient:nm})}}>{patSent?"‚úì Sent":"Send Plan"}</button>
      </div>
    </div>}
  </div>;
}


function PTPatientDetail({pt,onBack}){
  const[msgs,setMsgs]=useState(pt.msgs||[]);const[draft,setDraft]=useState("");
  const send=()=>{if(!draft.trim())return;setMsgs(p=>[...p,{fr:"pt",tx:draft,t:new Date().toLocaleString()}]);L("msg_sent",{to:pt.id});setDraft("")};
  const li=pt.iciq[pt.iciq.length-1].s,lp=pt.pain[pt.pain.length-1].s;
  return<div className="fi">
    <button className="btn bo bsm"onClick={onBack}style={{marginBottom:16}}>‚Üê Back to Patients</button>
    <div className="h1">{pt.nm}</div><div className="sub">Age {pt.age} ¬∑ Referred by {pt.ref}</div>
    <div className="three"style={{marginBottom:14}}>
      <div className="sc"><div className="scl2">Latest ICIQ</div><div className="scv2"style={{color:C.pink}}>{li}</div><Bdg sev={li<=5?"Slight":li<=12?"Moderate":li<=18?"Severe":"Very Severe"}/></div>
      <div className="sc"><div className="scl2">Latest Pain</div><div className="scv2"style={{color:C.or}}>{lp}</div><Bdg sev={lp<=3?"Mild":lp<=6?"Moderate":"Severe"}/></div>
      <div className="sc"><div className="scl2">Adherence</div><div className="scv2"style={{color:pt.adh>=80?C.gn:C.or}}>{pt.adh}%</div></div>
    </div>
    <div className="two">
      <div className="card"><div className="chd">Score History</div>
        <div style={{display:"flex",alignItems:"flex-end",gap:12,height:80,paddingBottom:10,borderBottom:`1px solid ${C.g100}`}}>
          {pt.iciq.map((s,i)=><div key={i}style={{flex:1,display:"flex",flexDirection:"column",alignItems:"center"}}>
            <div style={{width:24,height:`${(s.s/21)*100}%`,background:i===pt.iciq.length-1?C.pink:`${C.pink}44`,borderRadius:"3px 3px 0 0",minHeight:4}}/>
            <div style={{fontSize:9,color:C.g400,marginTop:4}}>{s.d}</div></div>)}
        </div></div>
      <div className="card"><div className="chd">Messages</div>
        <div style={{minHeight:100,maxHeight:160,overflowY:"auto"}}>
          {msgs.length===0&&<div style={{color:C.g400,fontSize:12,padding:20,textAlign:"center"}}>No messages yet.</div>}
          {msgs.map((m,i)=><div key={i}style={{display:"flex",flexDirection:"column",alignItems:m.fr==="pt"?"flex-end":"flex-start"}}>
            <div className={`msg ${m.fr==="pt"?"mpt":"mpa"}`}>{m.tx}</div><div style={{fontSize:9,color:C.g400,margin:"0 4px 6px"}}>{m.t}</div></div>)}
        </div>
        <div style={{borderTop:`1px solid ${C.g100}`,paddingTop:8,display:"flex",gap:6}}>
          <input className="inp"placeholder="Message..."value={draft}onChange={e=>setDraft(e.target.value)}onKeyDown={e=>e.key==="Enter"&&send()}/>
          <button className="btn bpu bsm"onClick={send}>Send</button>
        </div></div>
    </div></div>;
}

function PTDash(){
  const n=DPTS.length+(sharedIntake?1:0),aa=Math.round(DPTS.reduce((s,p)=>s+p.adh,0)/DPTS.length);
  const imp=DPTS.filter(p=>p.iciq.length>1).reduce((s,p)=>s+(p.iciq[0].s-p.iciq[p.iciq.length-1].s),0);
  const pend=DPTS.filter(p=>p.ps==="pending_review").length+(sharedIntake&&sharedIntake.plan?.status==="pending_review"?1:0);
  return<div className="fi"><div className="h1">Dashboard</div><div className="sub">Pilot overview</div>
    <div className="four"style={{marginBottom:16}}>
      <div className="sc"><div className="scl2">Enrolled</div><div className="scv2"style={{color:C.purp}}>{n}</div></div>
      <div className="sc"><div className="scl2">Avg Adherence</div><div className="scv2"style={{color:aa>=80?C.gn:C.or}}>{aa}%</div></div>
      <div className="sc"><div className="scl2">ICIQ Improvement</div><div className="scv2"style={{color:C.pink}}>-{imp}</div><div className="scs">avg reduction</div></div>
      <div className="sc"><div className="scl2">Pending Review</div><div className="scv2"style={{color:pend?C.or:C.gn}}>{pend}</div></div>
    </div>
    <div className="two">
      <div className="card"><div className="chd">ICIQ Trends</div><div style={{display:"flex",alignItems:"flex-end",gap:16,height:90,paddingBottom:10,borderBottom:`1px solid ${C.g100}`}}>
        {DPTS.map(p=><div key={p.id}style={{flex:1,display:"flex",flexDirection:"column",alignItems:"center"}}>
          <div style={{display:"flex",alignItems:"flex-end",gap:2,height:65}}>{p.iciq.map((s,i)=><div key={i}style={{width:14,height:`${(s.s/21)*100}%`,background:i===p.iciq.length-1?C.pink:`${C.pink}44`,borderRadius:"2px 2px 0 0",minHeight:3}}/>)}</div>
          <div style={{fontSize:9,color:C.g400,marginTop:5}}>{p.nm}</div></div>)}</div></div>
      <div className="card"><div className="chd">Pain Trends</div><div style={{display:"flex",alignItems:"flex-end",gap:16,height:90,paddingBottom:10,borderBottom:`1px solid ${C.g100}`}}>
        {DPTS.map(p=><div key={p.id}style={{flex:1,display:"flex",flexDirection:"column",alignItems:"center"}}>
          <div style={{display:"flex",alignItems:"flex-end",gap:2,height:65}}>{p.pain.map((s,i)=><div key={i}style={{width:14,height:`${(s.s/10)*100}%`,background:i===p.pain.length-1?C.or:`${C.or}44`,borderRadius:"2px 2px 0 0",minHeight:3}}/>)}</div>
          <div style={{fontSize:9,color:C.g400,marginTop:5}}>{p.nm}</div></div>)}</div></div>
    </div></div>;
}

function AuditLog(){
  const tc={consent_signed:C.blue,intake_done:C.pink,plan_generated:C.or,plan_reviewed:C.gn,plan_rejected:C.rd,encounter_note:C.purp,fax_init:C.g500,fax_confirmed:C.gn,plan_sent_patient:C.blue,msg_sent:C.g400};
  return<div className="fi"><div className="h1">Audit Log</div><div className="sub">Immutable record ¬∑ {log.length} entries</div>
    <div className="card"style={{padding:0,overflow:"hidden"}}>
      {log.length===0&&<div style={{padding:40,textAlign:"center",color:C.g400,fontSize:12}}>No events yet.</div>}
      {log.map(e=><div key={e.id}style={{padding:"10px 16px",borderBottom:`1px solid ${C.g100}`,fontSize:12,display:"flex",gap:10,alignItems:"flex-start"}}>
        <div style={{width:140,flexShrink:0,color:C.g400,fontSize:10}}>{new Date(e.ts).toLocaleString()}</div>
        <span className="bdg"style={{background:`${tc[e.type]||C.g400}12`,color:tc[e.type]||C.g400,flexShrink:0}}>{e.type.replace(/_/g," ")}</span>
        <div style={{color:C.g500,fontSize:10,wordBreak:"break-all"}}>{JSON.stringify(Object.fromEntries(Object.entries(e).filter(([k])=>!["id","ts","type"].includes(k))))}</div>
      </div>)}
    </div></div>;
}

function OAIPView(){
  const checks=[
    {cat:"Consumer Protection",items:[{l:"Informed consent with AI disclosure",s:1},{l:"Right to opt out",s:1},{l:"100% PT review (Phase 1)",s:1},{l:"Restitution language",s:1},{l:"Malpractice coverage",s:1}]},
    {cat:"Data Transparency",items:[{l:"OAIP monthly dashboard",s:1},{l:"Public anonymized dashboard",s:1},{l:"Researcher dataset (IRB)",s:1},{l:"External auditor access",s:1},{l:"FDA CDS exemption",s:1}]},
    {cat:"Operational Metrics",items:[{l:"AI-PT agreement ‚â•95%",s:1,v:"97.3%"},{l:"Adverse events",s:1,v:"0"},{l:"PHI breaches",s:1,v:"0"},{l:"Complaint rate",s:1,v:"0%"},{l:"Audit log",s:1,v:`${log.length} entries`}]},
    {cat:"Termination Triggers",items:[{l:"Adverse event ‚Üí immediate pause",s:2},{l:"PHI breach ‚Üí pause + notify",s:2},{l:"PT license action ‚Üí removal",s:2},{l:"OAIP request ‚Üí 48hr wind-down",s:2}]},
  ];
  const n=DPTS.length+(sharedIntake?1:0),aa=Math.round(DPTS.reduce((s,p)=>s+p.adh,0)/DPTS.length);
  return<div className="fi"><div className="h1">OAIP Compliance Dashboard</div><div className="sub">Utah Office of AI Policy ¬∑ Regulatory Mitigation Agreement</div>
    <div className="four"style={{marginBottom:16}}>
      <div className="sc"><div className="scl2">Phase</div><div style={{fontSize:16,fontWeight:700,color:C.purp}}>Phase 1</div><div className="scs">Shadow ¬∑ 100% review</div></div>
      <div className="sc"><div className="scl2">Enrolled</div><div className="scv2"style={{color:C.blue}}>{n}</div></div>
      <div className="sc"><div className="scl2">Adherence</div><div className="scv2"style={{color:C.gn}}>{aa}%</div></div>
      <div className="sc"><div className="scl2">Adverse</div><div className="scv2"style={{color:C.gn}}>0</div></div>
    </div>
    {checks.map(c=><div className="card"key={c.cat}><div className="chd">{c.cat}</div>
      {c.items.map((it,i)=><div key={i}style={{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"8px 0",borderBottom:i<c.items.length-1?`1px solid ${C.g100}`:"none"}}>
        <div style={{display:"flex",alignItems:"center",gap:8,fontSize:13}}><span style={{color:it.s===1?C.gn:C.blue,fontSize:15}}>{it.s===1?"‚úì":"‚óÜ"}</span>{it.l}</div>
        <span style={{fontSize:12,color:C.g500,fontWeight:500}}>{it.v||(it.s===1?"Compliant":"Armed")}</span>
      </div>)}
    </div>)}
    <div style={{display:"flex",gap:6,flexWrap:"wrap"}}>
      <button className="btn bo bsm">üìä Monthly Report</button><button className="btn bo bsm">üìã De-ID Dataset</button>
      <button className="btn bo bsm">üìà Public Dashboard</button><button className="btn bo bsm">üîç Audit Log</button>
    </div></div>;
}
// MAIN APP ‚Äî Three Views
function App(){
  const[mode,setMode]=useState("patient");const[pView,setPView]=useState("consent");
  const[ptView,setPtView]=useState("dash");
  const mainRef=useRef(null);
  const modes=[{id:"patient",l:"üë§ Patient View"},{id:"pt",l:"ü©∫ PT Provider View"},{id:"oaip",l:"üèõÔ∏è Utah OAIP View"}];

  return<><style>{css}</style>
    <div className="topnav">
      <div className="topnav-logo">EXPECT</div>
      <div className="topnav-tabs">
        {modes.map(m=><div key={m.id}className={`tt ${mode===m.id?"a":""}`}onClick={()=>{setMode(m.id);setPView("consent");setPtView("dash")}}>{m.l}</div>)}
      </div>
    </div>
    <div ref={mainRef} style={{overflowY:"auto",maxHeight:"calc(100vh - 56px)"}}>
      {mode==="patient"&&<div className="mn">
        {pView==="consent"&&<Consent onDone={()=>setPView("intake")}/>}
        {pView==="intake"&&<Intake onDone={()=>setPView("done")}mainRef={mainRef}/>}
      </div>}
      {mode==="pt"&&<div className="mnw">
        <div style={{display:"flex",gap:0,marginBottom:20,borderBottom:`1px solid ${C.g200}`}}>
          {[["dash","Dashboard"],["patients","Patients"],["audit","Audit Log"]].map(([id,l])=>
            <div key={id}style={{padding:"10px 18px",fontSize:13,fontWeight:ptView===id?600:400,color:ptView===id?C.purp:C.g400,borderBottom:`2px solid ${ptView===id?C.pink:"transparent"}`,cursor:"pointer"}}onClick={()=>setPtView(id)}>{l}</div>
          )}
        </div>
        {ptView==="dash"&&<PTDash/>}
        {ptView==="patients"&&<PTReview/>}
        {ptView==="audit"&&<AuditLog/>}
      </div>}
      {mode==="oaip"&&<div className="mnw"><OAIPView/></div>}
    </div>
  </>;
}


ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script></body></html>